(defpackage :valtan.remote-eval
  (:use :cl)
  (:export :connect))
(in-package :valtan.remote-eval)

(defun connect ()
  (labels ((connect-1 (&rest args)
             (declare (ignore args))
             (let ((ws (ffi:new #j:WebSocket #j"ws://0.0.0.0:40000/")))
               (ffi:set (ffi:ref ws :onmessage)
                        (lambda (e)
                          (#j:eval:call #j:window (ffi:ref e :data))))
               (ffi:set (ffi:ref ws :onopen)
                        (lambda (&rest args)
                          (declare (ignore args))
                          ((ffi:ref ws :send) #j"connected")))
               (ffi:set (ffi:ref ws :onclose)
                        (lambda (&rest args)
                          (declare (ignore args))
                          (#j:setTimeout connect-1 1))))))
    (connect-1)))
